Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.normalizeString = normalizeString;
exports.getRow = getRow;
exports.getTextInRange = getTextInRange;
exports.getRows = getRows;
exports.getSelectedText = getSelectedText;
exports.isComment = isComment;
exports.isBlank = isBlank;
exports.escapeBlankRows = escapeBlankRows;
exports.getFoldRange = getFoldRange;
exports.getFoldContents = getFoldContents;
exports.getCodeToInspect = getCodeToInspect;
exports.getRegexString = getRegexString;
exports.getBreakpoints = getBreakpoints;
exports.getCurrentCell = getCurrentCell;
exports.getCells = getCells;
exports.getCellsForBreakPoints = getCellsForBreakPoints;
exports.moveDown = moveDown;
exports.findPrecedingBlock = findPrecedingBlock;
exports.findCodeBlock = findCodeBlock;

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

var _atom = require("atom");

var _escapeStringRegexp = require("escape-string-regexp");

var _escapeStringRegexp2 = _interopRequireDefault(_escapeStringRegexp);

var _lodash = require("lodash");

var _lodash2 = _interopRequireDefault(_lodash);

var _utils = require("./utils");

function normalizeString(code) {
  if (code) {
    return code.replace(/\r\n|\r/g, "\n").trim();
  }
  return null;
}

function getRow(editor, row) {
  return normalizeString(editor.lineTextForBufferRow(row));
}

function getTextInRange(editor, start, end) {
  var code = editor.getTextInBufferRange([start, end]);
  return normalizeString(code);
}

function getRows(editor, startRow, endRow) {
  var code = editor.getTextInBufferRange({
    start: {
      row: startRow,
      column: 0
    },
    end: {
      row: endRow,
      column: 9999999
    }
  });
  return normalizeString(code);
}

function getSelectedText(editor) {
  return normalizeString(editor.getSelectedText());
}

function isComment(editor, position) {
  var scope = editor.scopeDescriptorForBufferPosition(position);
  var scopeString = scope.getScopeChain();
  return _lodash2["default"].includes(scopeString, "comment.line");
}

function isBlank(editor, row) {
  return editor.getBuffer().isRowBlank(row) || editor.isBufferRowCommented(row);
}

function escapeBlankRows(editor, startRow, endRow) {
  while (endRow > startRow) {
    if (!isBlank(editor, endRow)) break;
    endRow -= 1;
  }
  return endRow;
}

function getFoldRange(editor, row) {
  var range = (0, _utils.rowRangeForCodeFoldAtBufferRow)(editor, row);
  if (!range) return;
  if (range[1] < editor.getLastBufferRow() && getRow(editor, range[1] + 1) === "end") {
    range[1] += 1;
  }
  (0, _utils.log)("getFoldRange:", range);
  return range;
}

function getFoldContents(editor, row) {
  var range = getFoldRange(editor, row);
  if (!range) return;
  return [getRows(editor, range[0], range[1]), range[1]];
}

function getCodeToInspect(editor) {
  var selectedText = getSelectedText(editor);
  var code = undefined;
  var cursorPosition = undefined;
  if (selectedText) {
    code = selectedText;
    cursorPosition = code.length;
  } else {
    var cursor = editor.getLastCursor();
    var row = cursor.getBufferRow();
    code = getRow(editor, row);
    cursorPosition = cursor.getBufferColumn();

    // TODO: use kernel.complete to find a selection
    var identifierEnd = code ? code.slice(cursorPosition).search(/\W/) : -1;
    if (identifierEnd !== -1) {
      cursorPosition += identifierEnd;
    }
  }

  return [code, cursorPosition];
}

function getRegexString(editor) {
  var _editor$tokenizedBuffer$commentStringsForPosition =
  // $FlowFixMe: This is an unofficial API
  editor.tokenizedBuffer.commentStringsForPosition(editor.getCursorBufferPosition());

  var commentStartString = _editor$tokenizedBuffer$commentStringsForPosition.commentStartString;

  if (!commentStartString) {
    (0, _utils.log)("CellManager: No comment string defined in root scope");
    return null;
  }

  var escapedCommentStartString = (0, _escapeStringRegexp2["default"])(commentStartString.trimRight());

  var regexString = escapedCommentStartString + "(%%| %%| <codecell>| In[[0-9 ]*]:?)";

  return regexString;
}

function getBreakpoints(editor) {
  var buffer = editor.getBuffer();
  var breakpoints = [];

  var regexString = getRegexString(editor);
  if (regexString) {
    var regex = new RegExp(regexString, "g");
    buffer.scan(regex, function (_ref) {
      var range = _ref.range;

      breakpoints.push(range.start);
    });
  }

  breakpoints.push(buffer.getEndPosition());

  (0, _utils.log)("CellManager: Breakpoints:", breakpoints);

  return breakpoints;
}

function getCurrentCodeCell(editor) {
  var buffer = editor.getBuffer();
  var start = new _atom.Point(0, 0);
  var end = buffer.getEndPosition();
  var regexString = getRegexString(editor);

  if (!regexString) {
    return new _atom.Range(start, end);
  }

  var regex = new RegExp(regexString);
  var cursor = editor.getCursorBufferPosition();

  while (cursor.row < end.row && isComment(editor, cursor)) {
    cursor.row += 1;
    cursor.column = 0;
  }

  if (cursor.row > 0) {
    buffer.backwardsScanInRange(regex, new _atom.Range(start, cursor), function (_ref2) {
      var range = _ref2.range;

      start = new _atom.Point(range.start.row + 1, 0);
    });
  }

  buffer.scanInRange(regex, new _atom.Range(cursor, end), function (_ref3) {
    var range = _ref3.range;

    end = range.start;
  });

  (0, _utils.log)("CellManager: Cell [start, end]:", [start, end], "cursor:", cursor);

  return new _atom.Range(start, end);
}

function isEmbeddedCode(editor, referenceScope, row) {
  var scopes = editor.scopeDescriptorForBufferPosition(new _atom.Point(row, 0)).getScopesArray();
  return _lodash2["default"].includes(scopes, referenceScope);
}

function getCurrentFencedCodeBlock(editor) {
  var buffer = editor.getBuffer();

  var _buffer$getEndPosition = buffer.getEndPosition();

  var bufferEndRow = _buffer$getEndPosition.row;

  var cursor = editor.getCursorBufferPosition();
  var start = cursor.row;
  var end = cursor.row;
  var scope = (0, _utils.getEmbeddedScope)(editor, cursor);
  if (!scope) return getCurrentCodeCell(editor);
  while (start > 0 && isEmbeddedCode(editor, scope, start - 1)) {
    start -= 1;
  }

  while (end < bufferEndRow && isEmbeddedCode(editor, scope, end + 1)) {
    end += 1;
  }

  return new _atom.Range([start, 0], [end, 9999999]);
}

function getCurrentCell(editor) {
  if ((0, _utils.isMultilanguageGrammar)(editor.getGrammar())) {
    return getCurrentFencedCodeBlock(editor);
  }
  return getCurrentCodeCell(editor);
}

function getCells(editor) {
  var breakpoints = arguments.length <= 1 || arguments[1] === undefined ? [] : arguments[1];

  if (breakpoints.length !== 0) {
    breakpoints.sort(function (a, b) {
      return a.compare(b);
    });
  } else {
    breakpoints = getBreakpoints(editor);
  }
  return getCellsForBreakPoints(breakpoints);
}

function getCellsForBreakPoints(breakpoints) {
  var start = new _atom.Point(0, 0);
  return _lodash2["default"].map(breakpoints, function (end) {
    var cell = new _atom.Range(start, end);
    start = new _atom.Point(end.row + 1, 0);
    return cell;
  });
}

function moveDown(editor, row) {
  var lastRow = editor.getLastBufferRow();

  if (row >= lastRow) {
    editor.moveToBottom();
    editor.insertNewline();
    return;
  }

  while (row < lastRow) {
    row += 1;
    if (!isBlank(editor, row)) break;
  }

  editor.setCursorBufferPosition({
    row: row,
    column: 0
  });
}

function findPrecedingBlock(editor, row, indentLevel) {
  var previousRow = row - 1;
  while (previousRow >= 0) {
    var previousIndentLevel = editor.indentationForBufferRow(previousRow);
    var sameIndent = previousIndentLevel <= indentLevel;
    var blank = isBlank(editor, previousRow);
    var isEnd = getRow(editor, previousRow) === "end";

    if (isBlank(editor, row)) {
      row = previousRow;
    }
    if (sameIndent && !blank && !isEnd) {
      return [getRows(editor, previousRow, row), row];
    }
    previousRow -= 1;
  }
  return null;
}

function findCodeBlock(editor) {
  var selectedText = getSelectedText(editor);

  if (selectedText) {
    var selectedRange = editor.getSelectedBufferRange();
    var endRow = selectedRange.end.row;
    if (selectedRange.end.column === 0) {
      endRow -= 1;
    }
    endRow = escapeBlankRows(editor, selectedRange.start.row, endRow);
    return [selectedText, endRow];
  }

  var cursor = editor.getLastCursor();

  var row = cursor.getBufferRow();
  (0, _utils.log)("findCodeBlock:", row);

  var indentLevel = cursor.getIndentLevel();
  var foldable = editor.isFoldableAtBufferRow(row);
  var foldRange = (0, _utils.rowRangeForCodeFoldAtBufferRow)(editor, row);
  if (!foldRange || foldRange[0] == null || foldRange[1] == null) {
    foldable = false;
  }

  if (foldable) {
    return getFoldContents(editor, row);
  }
  if (isBlank(editor, row) || getRow(editor, row) === "end") {
    return findPrecedingBlock(editor, row, indentLevel);
  }
  return [getRow(editor, row), row];
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9yb290Ly5hdG9tL3BhY2thZ2VzL0h5ZHJvZ2VuL2xpYi9jb2RlLW1hbmFnZXIuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztvQkFFNkIsTUFBTTs7a0NBRUosc0JBQXNCOzs7O3NCQUN2QyxRQUFROzs7O3FCQU9mLFNBQVM7O0FBRVQsU0FBUyxlQUFlLENBQUMsSUFBYSxFQUFFO0FBQzdDLE1BQUksSUFBSSxFQUFFO0FBQ1IsV0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLFVBQVUsRUFBRSxJQUFJLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQztHQUM5QztBQUNELFNBQU8sSUFBSSxDQUFDO0NBQ2I7O0FBRU0sU0FBUyxNQUFNLENBQUMsTUFBdUIsRUFBRSxHQUFXLEVBQUU7QUFDM0QsU0FBTyxlQUFlLENBQUMsTUFBTSxDQUFDLG9CQUFvQixDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7Q0FDMUQ7O0FBRU0sU0FBUyxjQUFjLENBQzVCLE1BQXVCLEVBQ3ZCLEtBQWlCLEVBQ2pCLEdBQWUsRUFDZjtBQUNBLE1BQU0sSUFBSSxHQUFHLE1BQU0sQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDLEtBQUssRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFDO0FBQ3ZELFNBQU8sZUFBZSxDQUFDLElBQUksQ0FBQyxDQUFDO0NBQzlCOztBQUVNLFNBQVMsT0FBTyxDQUNyQixNQUF1QixFQUN2QixRQUFnQixFQUNoQixNQUFjLEVBQ2Q7QUFDQSxNQUFNLElBQUksR0FBRyxNQUFNLENBQUMsb0JBQW9CLENBQUM7QUFDdkMsU0FBSyxFQUFFO0FBQ0wsU0FBRyxFQUFFLFFBQVE7QUFDYixZQUFNLEVBQUUsQ0FBQztLQUNWO0FBQ0QsT0FBRyxFQUFFO0FBQ0gsU0FBRyxFQUFFLE1BQU07QUFDWCxZQUFNLEVBQUUsT0FBTztLQUNoQjtHQUNGLENBQUMsQ0FBQztBQUNILFNBQU8sZUFBZSxDQUFDLElBQUksQ0FBQyxDQUFDO0NBQzlCOztBQUVN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O0FBQ2pELE1BQU0sU0FBUyxHQUFHLDJDQUErQixNQUFNLEVBQUUsR0FBRyxDQUFDLENBQUM7QUFDOUQsTUFBSSxDQUFDLFNBQVMsSUFBSSxTQUFTLENBQUMsQ0FBQyxDQUFDLElBQUksSUFBSSxJQUFJLFNBQVMsQ0FBQyxDQUFDLENBQUMsSUFBSSxJQUFJLEVBQUU7QUFDOUQsWUFBUSxHQUFHLEtBQUssQ0FBQztHQUNsQjs7QUFFRCxNQUFJLFFBQVEsRUFBRTtBQUNaLFdBQU8sZUFBZSxDQUFDLE1BQU0sRUFBRSxHQUFHLENBQUMsQ0FBQztHQUNyQztBQUNELE1BQUksT0FBTyxDQUFDLE1BQU0sRUFBRSxHQUFHLENBQUMsSUFBSSxNQUFNLENBQUMsTUFBTSxFQUFFLEdBQUcsQ0FBQyxLQUFLLEtBQUssRUFBRTtBQUN6RCxXQUFPLGtCQUFrQixDQUFDLE1BQU0sRUFBRSxHQUFHLEVBQUUsV0FBVyxDQUFDLENBQUM7R0FDckQ7QUFDRCxTQUFPLENBQUMsTUFBTSxDQUFDLE1BQU0sRUFBRSxHQUFHLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQztDQUNuQyIsImZpbGUiOiIvcm9vdC8uYXRvbS9wYWNrYWdlcy9IeWRyb2dlbi9saWIvY29kZS1tYW5hZ2VyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyogQGZsb3cgKi9cblxuaW1wb3J0IHsgUG9pbnQsIFJhbmdlIH0gZnJvbSBcImF0b21cIjtcblxuaW1wb3J0IGVzY2FwZVN0cmluZ1JlZ2V4cCBmcm9tIFwiZXNjYXBlLXN0cmluZy1yZWdleHBcIjtcbmltcG9ydCBfIGZyb20gXCJsb2Rhc2hcIjtcblxuaW1wb3J0IHtcbiAgbG9nLFxuICBpc011bHRpbGFuZ3VhZ2VHcmFtbWFyLFxuICBnZXRFbWJlZGRlZFNjb3BlLFxuICByb3dSYW5nZUZvckNvZGVGb2xkQXRCdWZmZXJSb3dcbn0gZnJvbSBcIi4vdXRpbHNcIjtcblxuZXhwb3J0IGZ1bmN0aW9uIG5vcm1hbGl6ZVN0cmluZyhjb2RlOiA/c3RyaW5nKSB7XG4gIGlmIChjb2RlKSB7XG4gICAgcmV0dXJuIGNvZGUucmVwbGFjZSgvXFxyXFxufFxcci9nLCBcIlxcblwiKS50cmltKCk7XG4gIH1cbiAgcmV0dXJuIG51bGw7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRSb3coZWRpdG9yOiBhdG9tJFRleHRFZGl0b3IsIHJvdzogbnVtYmVyKSB7XG4gIHJldHVybiBub3JtYWxpemVTdHJpbmcoZWRpdG9yLmxpbmVUZXh0Rm9yQnVmZmVyUm93KHJvdykpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0VGV4dEluUmFuZ2UoXG4gIGVkaXRvcjogYXRvbSRUZXh0RWRpdG9yLFxuICBzdGFydDogYXRvbSRQb2ludCxcbiAgZW5kOiBhdG9tJFBvaW50XG4pIHtcbiAgY29uc3QgY29kZSA9IGVkaXRvci5nZXRUZXh0SW5CdWZmZXJSYW5nZShbc3RhcnQsIGVuZF0pO1xuICByZXR1cm4gbm9ybWFsaXplU3RyaW5nKGNvZGUpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0Um93cyhcbiAgZWRpdG9yOiBhdG9tJFRleHRFZGl0b3IsXG4gIHN0YXJ0Um93OiBudW1iZXIsXG4gIGVuZFJvdzogbnVtYmVyXG4pIHtcbiAgY29uc3QgY29kZSA9IGVkaXRvci5nZXRUZXh0SW5CdWZmZXJSYW5nZSh7XG4gICAgc3RhcnQ6IHtcbiAgICAgIHJvdzogc3RhcnRSb3csXG4gICAgICBjb2x1bW46IDBcbiAgICB9LFxuICAgIGVuZDoge1xuICAgICAgcm93OiBlbmRSb3csXG4gICAgICBjb2x1bW46IDk5OTk5OTlcbiAgICB9XG4gIH0pO1xuICByZXR1cm4gbm9ybWFsaXplU3RyaW5nKGNvZGUpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0U2VsZWN0ZWRUZXh0KGVkaXRvcjogYXRvbSRUZXh0RWRpdG9yKSB7XG4gIHJldHVybiBub3JtYWxpemVTdHJpbmcoZWRpdG9yLmdldFNlbGVjdGVkVGV4dCgpKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGlzQ29tbWVudChlZGl0b3I6IGF0b20kVGV4dEVkaXRvciwgcG9zaXRpb246IGF0b20kUG9pbnQpIHtcbiAgY29uc3Qgc2NvcGUgPSBlZGl0b3Iuc2NvcGVEZXNjcmlwdG9yRm9yQnVmZmVyUG9zaXRpb24ocG9zaXRpb24pO1xuICBjb25zdCBzY29wZVN0cmluZyA9IHNjb3BlLmdldFNjb3BlQ2hhaW4oKTtcbiAgcmV0dXJuIF8uaW5jbHVkZXMoc2NvcGVTdHJpbmcsIFwiY29tbWVudC5saW5lXCIpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gaXNCbGFuayhlZGl0b3I6IGF0b20kVGV4dEVkaXRvciwgcm93OiBudW1iZXIpIHtcbiAgcmV0dXJuIGVkaXRvci5nZXRCdWZmZXIoKS5pc1Jvd0JsYW5rKHJvdykgfHwgZWRpdG9yLmlzQnVmZmVyUm93Q29tbWVudGVkKHJvdyk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBlc2NhcGVCbGFua1Jvd3MoXG4gIGVkaXRvcjogYXRvbSRUZXh0RWRpdG9yLFxuICBzdGFydFJvdzogbnVtYmVyLFxuICBlbmRSb3c6IG51bWJlclxuKSB7XG4gIHdoaWxlIChlbmRSb3cgPiBzdGFydFJvdykge1xuICAgIGlmICghaXNCbGFuayhlZGl0b3IsIGVuZFJvdykpIGJyZWFrO1xuICAgIGVuZFJvdyAtPSAxO1xuICB9XG4gIHJldHVybiBlbmRSb3c7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRGb2xkUmFuZ2UoZWRpdG9yOiBhdG9tJFRleHRFZGl0b3IsIHJvdzogbnVtYmVyKSB7XG4gIGNvbnN0IHJhbmdlID0gcm93UmFuZ2VGb3JDb2RlRm9sZEF0QnVmZmVyUm93KGVkaXRvciwgcm93KTtcbiAgaWYgKCFyYW5nZSkgcmV0dXJuO1xuICBpZiAoXG4gICAgcmFuZ2VbMV0gPCBlZGl0b3IuZ2V0TGFzdEJ1ZmZlclJvdygpICYmXG4gICAgZ2V0Um93KGVkaXRvciwgcmFuZ2VbMV0gKyAxKSA9PT0gXCJlbmRcIlxuICApIHtcbiAgICByYW5nZVsxXSArPSAxO1xuICB9XG4gIGxvZyhcImdldEZvbGRSYW5nZTpcIiwgcmFuZ2UpO1xuICByZXR1cm4gcmFuZ2U7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRGb2xkQ29udGVudHMoZWRpdG9yOiBhdG9tJFRleHRFZGl0b3IsIHJvdzogbnVtYmVyKSB7XG4gIGNvbnN0IHJhbmdlID0gZ2V0Rm9sZFJhbmdlKGVkaXRvciwgcm93KTtcbiAgaWYgKCFyYW5nZSkgcmV0dXJuO1xuICByZXR1cm4gW2dldFJvd3MoZWRpdG9yLCByYW5nZVswXSwgcmFuZ2VbMV0pLCByYW5nZVsxXV07XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRDb2RlVG9JbnNwZWN0KGVkaXRvcjogYXRvbSRUZXh0RWRpdG9yKSB7XG4gIGNvbnN0IHNlbGVjdGVkVGV4dCA9IGdldFNlbGVjdGVkVGV4dChlZGl0b3IpO1xuICBsZXQgY29kZTtcbiAgbGV0IGN1cnNvclBvc2l0aW9uO1xuICBpZiAoc2VsZWN0ZWRUZXh0KSB7XG4gICAgY29kZSA9IHNlbGVjdGVkVGV4dDtcbiAgICBjdXJzb3JQb3NpdGlvbiA9IGNvZGUubGVuZ3RoO1xuICB9IGVsc2Uge1xuICAgIGNvbnN0IGN1cnNvciA9IGVkaXRvci5nZXRMYXN0Q3Vyc29yKCk7XG4gICAgY29uc3Qgcm93ID0gY3Vyc29yLmdldEJ1ZmZlclJvdygpO1xuICAgIGNvZGUgPSBnZXRSb3coZWRpdG9yLCByb3cpO1xuICAgIGN1cnNvclBvc2l0aW9uID0gY3Vyc29yLmdldEJ1ZmZlckNvbHVtbigpO1xuXG4gICAgLy8gVE9ETzogdXNlIGtlcm5lbC5jb21wbGV0ZSB0byBmaW5kIGEgc2VsZWN0aW9uXG4gICAgY29uc3QgaWRlbnRpZmllckVuZCA9IGNvZGUgPyBjb2RlLnNsaWNlKGN1cnNvclBvc2l0aW9uKS5zZWFyY2goL1xcVy8pIDogLTE7XG4gICAgaWYgKGlkZW50aWZpZXJFbmQgIT09IC0xKSB7XG4gICAgICBjdXJzb3JQb3NpdGlvbiArPSBpZGVudGlmaWVyRW5kO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiBbY29kZSwgY3Vyc29yUG9zaXRpb25dO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0UmVnZXhTdHJpbmcoZWRpdG9yOiBhdG9tJFRleHRFZGl0b3IpIHtcbiAgY29uc3Qge1xuICAgIGNvbW1lbnRTdGFydFN0cmluZ1xuICAgIC8vICRGbG93Rml4TWU6IFRoaXMgaXMgYW4gdW5vZmZpY2lhbCBBUElcbiAgfSA9IGVkaXRvci50b2tlbml6ZWRCdWZmZXIuY29tbWVudFN0cmluZ3NGb3JQb3NpdGlvbihcbiAgICBlZGl0b3IuZ2V0Q3Vyc29yQnVmZmVyUG9zaXRpb24oKVxuICApO1xuXG4gIGlmICghY29tbWVudFN0YXJ0U3RyaW5nKSB7XG4gICAgbG9nKFwiQ2VsbE1hbmFnZXI6IE5vIGNvbW1lbnQgc3RyaW5nIGRlZmluZWQgaW4gcm9vdCBzY29wZVwiKTtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIGNvbnN0IGVzY2FwZWRDb21tZW50U3RhcnRTdHJpbmcgPSBlc2NhcGVTdHJpbmdSZWdleHAoXG4gICAgY29tbWVudFN0YXJ0U3RyaW5nLnRyaW1SaWdodCgpXG4gICk7XG5cbiAgY29uc3QgcmVnZXhTdHJpbmcgPSBgJHtlc2NhcGVkQ29tbWVudFN0YXJ0U3RyaW5nfSglJXwgJSV8IDxjb2RlY2VsbD58IEluXFxbWzAtOSBdKlxcXTo/KWA7XG5cbiAgcmV0dXJuIHJlZ2V4U3RyaW5nO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0QnJlYWtwb2ludHMoZWRpdG9yOiBhdG9tJFRleHRFZGl0b3IpIHtcbiAgY29uc3QgYnVmZmVyID0gZWRpdG9yLmdldEJ1ZmZlcigpO1xuICBjb25zdCBicmVha3BvaW50cyA9IFtdO1xuXG4gIGNvbnN0IHJlZ2V4U3RyaW5nID0gZ2V0UmVnZXhTdHJpbmcoZWRpdG9yKTtcbiAgaWYgKHJlZ2V4U3RyaW5nKSB7XG4gICAgY29uc3QgcmVnZXggPSBuZXcgUmVnRXhwKHJlZ2V4U3RyaW5nLCBcImdcIik7XG4gICAgYnVmZmVyLnNjYW4ocmVnZXgsICh7IHJhbmdlIH0pID0+IHtcbiAgICAgIGJyZWFrcG9pbnRzLnB1c2gocmFuZ2Uuc3RhcnQpO1xuICAgIH0pO1xuICB9XG5cbiAgYnJlYWtwb2ludHMucHVzaChidWZmZXIuZ2V0RW5kUG9zaXRpb24oKSk7XG5cbiAgbG9nKFwiQ2VsbE1hbmFnZXI6IEJyZWFrcG9pbnRzOlwiLCBicmVha3BvaW50cyk7XG5cbiAgcmV0dXJuIGJyZWFrcG9pbnRzO1xufVxuXG5mdW5jdGlvbiBnZXRDdXJyZW50Q29kZUNlbGwoZWRpdG9yOiBhdG9tJFRleHRFZGl0b3IpIHtcbiAgY29uc3QgYnVmZmVyID0gZWRpdG9yLmdldEJ1ZmZlcigpO1xuICBsZXQgc3RhcnQgPSBuZXcgUG9pbnQoMCwgMCk7XG4gIGxldCBlbmQgPSBidWZmZXIuZ2V0RW5kUG9zaXRpb24oKTtcbiAgY29uc3QgcmVnZXhTdHJpbmcgPSBnZXRSZWdleFN0cmluZyhlZGl0b3IpO1xuXG4gIGlmICghcmVnZXhTdHJpbmcpIHtcbiAgICByZXR1cm4gbmV3IFJhbmdlKHN0YXJ0LCBlbmQpO1xuICB9XG5cbiAgY29uc3QgcmVnZXggPSBuZXcgUmVnRXhwKHJlZ2V4U3RyaW5nKTtcbiAgY29uc3QgY3Vyc29yID0gZWRpdG9yLmdldEN1cnNvckJ1ZmZlclBvc2l0aW9uKCk7XG5cbiAgd2hpbGUgKGN1cnNvci5yb3cgPCBlbmQucm93ICYmIGlzQ29tbWVudChlZGl0b3IsIGN1cnNvcikpIHtcbiAgICBjdXJzb3Iucm93ICs9IDE7XG4gICAgY3Vyc29yLmNvbHVtbiA9IDA7XG4gIH1cblxuICBpZiAoY3Vyc29yLnJvdyA+IDApIHtcbiAgICBidWZmZXIuYmFja3dhcmRzU2NhbkluUmFuZ2UoXG4gICAgICByZWdleCxcbiAgICAgIG5ldyBSYW5nZShzdGFydCwgY3Vyc29yKSxcbiAgICAgICh7IHJhbmdlIH0pID0+IHtcbiAgICAgICAgc3RhcnQgPSBuZXcgUG9pbnQocmFuZ2Uuc3RhcnQucm93ICsgMSwgMCk7XG4gICAgICB9XG4gICAgKTtcbiAgfVxuXG4gIGJ1ZmZlci5zY2FuSW5SYW5nZShyZWdleCwgbmV3IFJhbmdlKGN1cnNvciwgZW5kKSwgKHsgcmFuZ2UgfSkgPT4ge1xuICAgIGVuZCA9IHJhbmdlLnN0YXJ0O1xuICB9KTtcblxuICBsb2coXCJDZWxsTWFuYWdlcjogQ2VsbCBbc3RhcnQsIGVuZF06XCIsIFtzdGFydCwgZW5kXSwgXCJjdXJzb3I6XCIsIGN1cnNvcik7XG5cbiAgcmV0dXJuIG5ldyBSYW5nZShzdGFydCwgZW5kKTtcbn1cblxuZnVuY3Rpb24gaXNFbWJlZGRlZENvZGUoXG4gIGVkaXRvcjogYXRvbSRUZXh0RWRpdG9yLFxuICByZWZlcmVuY2VTY29wZTogc3RyaW5nLFxuICByb3c6IG51bWJlclxuKSB7XG4gIGNvbnN0IHNjb3BlcyA9IGVkaXRvclxuICAgIC5zY29wZURlc2NyaXB0b3JGb3JCdWZmZXJQb3NpdGlvbihuZXcgUG9pbnQocm93LCAwKSlcbiAgICAuZ2V0U2NvcGVzQXJyYXkoKTtcbiAgcmV0dXJuIF8uaW5jbHVkZXMoc2NvcGVzLCByZWZlcmVuY2VTY29wZSk7XG59XG5cbmZ1bmN0aW9uIGdldEN1cnJlbnRGZW5jZWRDb2RlQmxvY2soZWRpdG9yOiBhdG9tJFRleHRFZGl0b3IpIHtcbiAgY29uc3QgYnVmZmVyID0gZWRpdG9yLmdldEJ1ZmZlcigpO1xuICBjb25zdCB7IHJvdzogYnVmZmVyRW5kUm93IH0gPSBidWZmZXIuZ2V0RW5kUG9zaXRpb24oKTtcblxuICBjb25zdCBjdXJzb3IgPSBlZGl0b3IuZ2V0Q3Vyc29yQnVmZmVyUG9zaXRpb24oKTtcbiAgbGV0IHN0YXJ0ID0gY3Vyc29yLnJvdztcbiAgbGV0IGVuZCA9IGN1cnNvci5yb3c7XG4gIGNvbnN0IHNjb3BlID0gZ2V0RW1iZWRkZWRTY29wZShlZGl0b3IsIGN1cnNvcik7XG4gIGlmICghc2NvcGUpIHJldHVybiBnZXRDdXJyZW50Q29kZUNlbGwoZWRpdG9yKTtcbiAgd2hpbGUgKHN0YXJ0ID4gMCAmJiBpc0VtYmVkZGVkQ29kZShlZGl0b3IsIHNjb3BlLCBzdGFydCAtIDEpKSB7XG4gICAgc3RhcnQgLT0gMTtcbiAgfVxuXG4gIHdoaWxlIChlbmQgPCBidWZmZXJFbmRSb3cgJiYgaXNFbWJlZGRlZENvZGUoZWRpdG9yLCBzY29wZSwgZW5kICsgMSkpIHtcbiAgICBlbmQgKz0gMTtcbiAgfVxuXG4gIHJldHVybiBuZXcgUmFuZ2UoW3N0YXJ0LCAwXSwgW2VuZCwgOTk5OTk5OV0pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0Q3VycmVudENlbGwoZWRpdG9yOiBhdG9tJFRleHRFZGl0b3IpIHtcbiAgaWYgKGlzTXVsdGlsYW5ndWFnZUdyYW1tYXIoZWRpdG9yLmdldEdyYW1tYXIoKSkpIHtcbiAgICByZXR1cm4gZ2V0Q3VycmVudEZlbmNlZENvZGVCbG9jayhlZGl0b3IpO1xuICB9XG4gIHJldHVybiBnZXRDdXJyZW50Q29kZUNlbGwoZWRpdG9yKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldENlbGxzKFxuICBlZGl0b3I6IGF0b20kVGV4dEVkaXRvcixcbiAgYnJlYWtwb2ludHM6IEFycmF5PGF0b20kUG9pbnQ+ID0gW11cbikge1xuICBpZiAoYnJlYWtwb2ludHMubGVuZ3RoICE9PSAwKSB7XG4gICAgYnJlYWtwb2ludHMuc29ydCgoYSwgYikgPT4gYS5jb21wYXJlKGIpKTtcbiAgfSBlbHNlIHtcbiAgICBicmVha3BvaW50cyA9IGdldEJyZWFrcG9pbnRzKGVkaXRvcik7XG4gIH1cbiAgcmV0dXJuIGdldENlbGxzRm9yQnJlYWtQb2ludHMoYnJlYWtwb2ludHMpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0Q2VsbHNGb3JCcmVha1BvaW50cyhicmVha3BvaW50czogQXJyYXk8YXRvbSRQb2ludD4pIHtcbiAgbGV0IHN0YXJ0ID0gbmV3IFBvaW50KDAsIDApO1xuICByZXR1cm4gXy5tYXAoYnJlYWtwb2ludHMsIGVuZCA9PiB7XG4gICAgY29uc3QgY2VsbCA9IG5ldyBSYW5nZShzdGFydCwgZW5kKTtcbiAgICBzdGFydCA9IG5ldyBQb2ludChlbmQucm93ICsgMSwgMCk7XG4gICAgcmV0dXJuIGNlbGw7XG4gIH0pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gbW92ZURvd24oZWRpdG9yOiBhdG9tJFRleHRFZGl0b3IsIHJvdzogbnVtYmVyKSB7XG4gIGNvbnN0IGxhc3RSb3cgPSBlZGl0b3IuZ2V0TGFzdEJ1ZmZlclJvdygpO1xuXG4gIGlmIChyb3cgPj0gbGFzdFJvdykge1xuICAgIGVkaXRvci5tb3ZlVG9Cb3R0b20oKTtcbiAgICBlZGl0b3IuaW5zZXJ0TmV3bGluZSgpO1xuICAgIHJldHVybjtcbiAgfVxuXG4gIHdoaWxlIChyb3cgPCBsYXN0Um93KSB7XG4gICAgcm93ICs9IDE7XG4gICAgaWYgKCFpc0JsYW5rKGVkaXRvciwgcm93KSkgYnJlYWs7XG4gIH1cblxuICBlZGl0b3Iuc2V0Q3Vyc29yQnVmZmVyUG9zaXRpb24oe1xuICAgIHJvdyxcbiAgICBjb2x1bW46IDBcbiAgfSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBmaW5kUHJlY2VkaW5nQmxvY2soXG4gIGVkaXRvcjogYXRvbSRUZXh0RWRpdG9yLFxuICByb3c6IG51bWJlcixcbiAgaW5kZW50TGV2ZWw6IG51bWJlclxuKSB7XG4gIGxldCBwcmV2aW91c1JvdyA9IHJvdyAtIDE7XG4gIHdoaWxlIChwcmV2aW91c1JvdyA+PSAwKSB7XG4gICAgY29uc3QgcHJldmlvdXNJbmRlbnRMZXZlbCA9IGVkaXRvci5pbmRlbnRhdGlvbkZvckJ1ZmZlclJvdyhwcmV2aW91c1Jvdyk7XG4gICAgY29uc3Qgc2FtZUluZGVudCA9IHByZXZpb3VzSW5kZW50TGV2ZWwgPD0gaW5kZW50TGV2ZWw7XG4gICAgY29uc3QgYmxhbmsgPSBpc0JsYW5rKGVkaXRvciwgcHJldmlvdXNSb3cpO1xuICAgIGNvbnN0IGlzRW5kID0gZ2V0Um93KGVkaXRvciwgcHJldmlvdXNSb3cpID09PSBcImVuZFwiO1xuXG4gICAgaWYgKGlzQmxhbmsoZWRpdG9yLCByb3cpKSB7XG4gICAgICByb3cgPSBwcmV2aW91c1JvdztcbiAgICB9XG4gICAgaWYgKHNhbWVJbmRlbnQgJiYgIWJsYW5rICYmICFpc0VuZCkge1xuICAgICAgcmV0dXJuIFtnZXRSb3dzKGVkaXRvciwgcHJldmlvdXNSb3csIHJvdyksIHJvd107XG4gICAgfVxuICAgIHByZXZpb3VzUm93IC09IDE7XG4gIH1cbiAgcmV0dXJuIG51bGw7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBmaW5kQ29kZUJsb2NrKGVkaXRvcjogYXRvbSRUZXh0RWRpdG9yKSB7XG4gIGNvbnN0IHNlbGVjdGVkVGV4dCA9IGdldFNlbGVjdGVkVGV4dChlZGl0b3IpO1xuXG4gIGlmIChzZWxlY3RlZFRleHQpIHtcbiAgICBjb25zdCBzZWxlY3RlZFJhbmdlID0gZWRpdG9yLmdldFNlbGVjdGVkQnVmZmVyUmFuZ2UoKTtcbiAgICBsZXQgZW5kUm93ID0gc2VsZWN0ZWRSYW5nZS5lbmQucm93O1xuICAgIGlmIChzZWxlY3RlZFJhbmdlLmVuZC5jb2x1bW4gPT09IDApIHtcbiAgICAgIGVuZFJvdyAtPSAxO1xuICAgIH1cbiAgICBlbmRSb3cgPSBlc2NhcGVCbGFua1Jvd3MoZWRpdG9yLCBzZWxlY3RlZFJhbmdlLnN0YXJ0LnJvdywgZW5kUm93KTtcbiAgICByZXR1cm4gW3NlbGVjdGVkVGV4dCwgZW5kUm93XTtcbiAgfVxuXG4gIGNvbnN0IGN1cnNvciA9IGVkaXRvci5nZXRMYXN0Q3Vyc29yKCk7XG5cbiAgY29uc3Qgcm93ID0gY3Vyc29yLmdldEJ1ZmZlclJvdygpO1xuICBsb2coXCJmaW5kQ29kZUJsb2NrOlwiLCByb3cpO1xuXG4gIGNvbnN0IGluZGVudExldmVsID0gY3Vyc29yLmdldEluZGVudExldmVsKCk7XG4gIGxldCBmb2xkYWJsZSA9IGVkaXRvci5pc0ZvbGRhYmxlQXRCdWZmZXJSb3cocm93KTtcbiAgY29uc3QgZm9sZFJhbmdlID0gcm93UmFuZ2VGb3JDb2RlRm9sZEF0QnVmZmVyUm93KGVkaXRvciwgcm93KTtcbiAgaWYgKCFmb2xkUmFuZ2UgfHwgZm9sZFJhbmdlWzBdID09IG51bGwgfHwgZm9sZFJhbmdlWzFdID09IG51bGwpIHtcbiAgICBmb2xkYWJsZSA9IGZhbHNlO1xuICB9XG5cbiAgaWYgKGZvbGRhYmxlKSB7XG4gICAgcmV0dXJuIGdldEZvbGRDb250ZW50cyhlZGl0b3IsIHJvdyk7XG4gIH1cbiAgaWYgKGlzQmxhbmsoZWRpdG9yLCByb3cpIHx8IGdldFJvdyhlZGl0b3IsIHJvdykgPT09IFwiZW5kXCIpIHtcbiAgICByZXR1cm4gZmluZFByZWNlZGluZ0Jsb2NrKGVkaXRvciwgcm93LCBpbmRlbnRMZXZlbCk7XG4gIH1cbiAgcmV0dXJuIFtnZXRSb3coZWRpdG9yLCByb3cpLCByb3ddO1xufVxuIl19